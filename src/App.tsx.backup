import { useState, useEffect } from 'react'
import Login from './pages/Login'
import AuthCallback from './pages/AuthCallback'
import WebUpload from './pages/WebUpload'
import Analyzing from './pages/Analyzing'
import Result from './pages/Result'
import AccountPanel from './components/AccountPanel'
import { uploadFile, getScore } from './api'
import { useAuthStore } from './store/authStore'
import { logout as apiLogout } from './api/auth'
import './App.css'

type AppState = 'login' | 'callback' | 'upload' | 'analyzing' | 'results'

interface UploadHistory {
  id: string;
  fileName: string;
  uploadDate: Date;
  score: number;
}

function App() {
  const [appState, setAppState] = useState<AppState>('login')
  const [isAccountPanelOpen, setIsAccountPanelOpen] = useState<boolean>(false)
  const [uploadHistory, setUploadHistory] = useState<UploadHistory[]>([])
  const [_taskId, setTaskId] = useState<string | null>(null)
  const [_error, setError] = useState<string | null>(null)

  // Zustand 스토어에서 인증 정보 가져오기
  const { user, isAuthenticated, logout: storeLogout } = useAuthStore()

  // 컴포넌트 마운트 시 URL 확인 (callback 처리)
  useEffect(() => {
    const urlParams = new URLSearchParams(window.location.search)
    const code = urlParams.get('code')
    
    if (code) {
      // OAuth callback 처리
      setAppState('callback')
    } else if (isAuthenticated && appState === 'login') {
      // 이미 로그인된 상태면 업로드 페이지로 이동
      setAppState('upload')
    }
  }, [isAuthenticated, appState])

  const handleLogin = () => {
    // Login 버튼 클릭 시 (실제 로그인은 Google OAuth에서 처리)
    console.log('Redirecting to Google login...')
  }

  const handleAuthSuccess = () => {
    // OAuth 인증 성공 후 호출
    console.log('Authentication successful')
    // URL에서 code 파라미터 제거
    window.history.replaceState({}, document.title, window.location.pathname)
    setAppState('upload')
  }

  const handleAuthError = () => {
    // OAuth 인증 실패 시 호출
    console.error('Authentication failed')
    // URL에서 code 파라미터 제거
    window.history.replaceState({}, document.title, window.location.pathname)
    setAppState('login')
  }

  const handleLogout = async () => {
    try {
      await apiLogout()
    } catch (error) {
      console.error('로그아웃 API 호출 실패:', error)
    }
    storeLogout()
    setAppState('login')
    setIsAccountPanelOpen(false)
  }

  const getUserInitial = () => {
    if (!user?.name) return 'U'
    return user.name.charAt(0).toUpperCase()
  }

  const handleProfileClick = () => {
    setIsAccountPanelOpen(true)
  }

  const handleCloseAccountPanel = () => {
    setIsAccountPanelOpen(false)
  }

  const handleUpload = async (file: File) => {
    console.log('File uploaded:', file)
    setAppState('analyzing')
    setError(null)
    
    try {
      // 1. 파일 업로드
      const uploadResult = await uploadFile(file)
      
      console.log('Upload success:', uploadResult)
      const uploadedTaskId = uploadResult?.task_id
      setTaskId(uploadedTaskId)
      
      // 2. 3초 후 점수 조회 (실제로는 서버에서 완료 신호를 받거나 폴링 사용)
      setTimeout(async () => {
        try {
          const scoreResult = await getScore()
          console.log('Score retrieved:', scoreResult)
          
          // 히스토리에 추가
          const newHistoryItem: UploadHistory = {
            id: uploadedTaskId || Date.now().toString(),
            fileName: file.name,
            uploadDate: new Date(),
            score: scoreResult?.score || 0
          }
          setUploadHistory(prev => [newHistoryItem, ...prev])
          
          setAppState('results')
        } catch (scoreErr: any) {
          if (scoreErr.response) {
            const data = scoreErr.response.data;
            const dataStr = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
            console.error(`❌ Failed to get score [${scoreErr.response.status}]:`, dataStr);
          } else {
            console.error('❌ Failed to get score (네트워크 에러):', scoreErr.message);
          }
          setError('Failed to get score')
          alert('점수 조회 실패')
          setAppState('upload')
        }
      }, 3000)
      
    } catch (err: any) {
      if (err.response) {
        const data = err.response.data;
        const dataStr = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
        console.error(`❌ Unexpected error [${err.response.status}]:`, dataStr);
      } else {
        console.error('❌ Unexpected error (네트워크 에러):', err.message);
      }
      setError('Unexpected error occurred')
      setAppState('upload')
      alert('예상치 못한 오류가 발생했습니다.')
    }
  }

  const handleReset = () => {
    setAppState('upload')
    setTaskId(null)
    setError(null)
  }

  return (
    <>
      {appState === 'login' && <Login onLogin={handleLogin} />}
      {appState === 'callback' && (
        <AuthCallback 
          onSuccess={handleAuthSuccess} 
          onError={handleAuthError} 
        />
      )}
      {appState === 'upload' && isAuthenticated && (
        <WebUpload 
          onUpload={handleUpload} 
          userInitial={getUserInitial()} 
          onProfileClick={handleProfileClick}
        />
      )}
      {appState === 'analyzing' && isAuthenticated && (
        <Analyzing 
          userInitial={getUserInitial()} 
          onProfileClick={handleProfileClick}
        />
      )}
      {appState === 'results' && isAuthenticated && (
        <Result 
          onReset={handleReset} 
          userInitial={getUserInitial()} 
          onProfileClick={handleProfileClick}
        />
      )}
      
      {/* Account Panel */}
      {isAuthenticated && (
        <AccountPanel
          isOpen={isAccountPanelOpen}
          onClose={handleCloseAccountPanel}
          userName={user?.name || ''}
          userEmail={user?.email || ''}
          userInitial={getUserInitial()}
          uploadHistory={uploadHistory}
          onLogout={handleLogout}
        />
      )}
    </>
  )
}

export default App
